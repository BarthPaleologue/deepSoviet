<!DOCTYPE HTML>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Deep Soviet</title>
    <link rel="icon" href="deepSoviet.ico" />
    <link rel="stylesheet" href="css/style.css" />
    <script src="js/actions.js"></script>

</head>

<body>
    <div id="loading-overlay">
        <p>Veuillez Patienter pendant que <span id="angerRed">deepSoviet</span> <span id="action"></span></p>

        <div id="loader">
            <div id="r3">
                <div id="r2">
                    <div id="r1">
                        <div id="hal"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script>
        document.getElementById("action").innerHTML = actions.getRandomIndex();
    </script>

    <h1>Deep Soviet</h1>

    <p id="status"></p>


    <div id="image-container">
        <img id="image" src="" />
    </div>

    <div id="UI">
        <div id="progressbar-container">
            <div id="progressbar"></div>
            <p id="rate">0%</p>
        </div>
    </div>


    <div class="upload-btn-wrapper">
        <button class="btn">Tester le Communisme</button>
        <input type="file" id="img_selector" />
    </div>

    <p id="version">deepSoviet<sub>v1.0</sub></p>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@0.12.5"></script>
    <script>
        const anthem = new Audio('anthems/anthem.mp3');
        const earrape = new Audio('anthems/earrape.mp3');

        anthem.load();
        earrape.load();

        var model;
        (async function getModel() {
            model = await tf.loadModel("TFJS/model.json");
            console.log(model);
            $("#loading-overlay").fadeOut();
        })();

        var image;
        $("#img_selector").on("change", e => {
            console.log(e);
            $("#status").fadeOut(0);
            earrape.load();
            anthem.load();
            let reader = new FileReader();
            reader.onload = e => {
                $("#image").attr("src", reader.result);
                $("#image").fadeIn(100, () => {
                    setTimeout(() => $("#image").css("margin-left", ($(window).width() - $("#image").width()) / 2), 10);
                    request();
                });
            }

            reader.readAsDataURL($("#img_selector")[0].files[0]);

            $("#UI").slideDown();
            $("#progressbar").animate({
                "width": "0%"
            }, 1);
            $("#rate").text("Analyse...");
        });

        function preprocess_image(imageData) {
            let offset = tf.scalar(127.5);
            return imageData.sub(offset).div(offset).expandDims(); // valeurs RGB entre -1 et 1
        }


        async function request() {

            let image = await $("#image").get(0);

            let tensor = await tf.fromPixels(image).resizeNearestNeighbor([224, 224]).toFloat();

            tensor = await preprocess_image(tensor);

            let predictions = await model.predict(tensor).data();

            console.log(predictions);

            let result = Math.round(predictions[0] * 100);

            if (result == 100) {
                $("#status").text("Membre du Parti !");
                earrape.play();
            } else if (result > 50) {
                anthem.play();
                anthem.volume = result / 100;
                $("#status").text("Communisme Acceptable");
            } else if (result < 50) {
                $("#status").text("GOULAG !");
            }
            $("#progressbar").animate({
                "width": result + "%"
            }, 1000);
            setTimeout(() => $("#status").fadeIn(0), 1000);
            for (let i = 0; i <= result; i++) {
                setTimeout(() => {
                    $("#rate").text(i + "%");
                }, 1000 * i / result);
            }

            predictions = null;

            $(".upload-btn-wrapper").addClass("down");
        }
    </script>
</body>



</html>